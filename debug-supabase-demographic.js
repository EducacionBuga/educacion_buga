// Script de diagn√≥stico avanzado para datos demogr√°ficos en Supabase
// Ejecutar en la consola del navegador para diagnosticar problemas

console.log('üîç INICIANDO DIAGN√ìSTICO AVANZADO DE DATOS DEMOGR√ÅFICOS');

// 1. Verificar autenticaci√≥n de Supabase
function verificarAutenticacion() {
    console.log('\nüìã 1. VERIFICANDO AUTENTICACI√ìN');
    
    // Verificar si Supabase est√° disponible
    if (typeof window !== 'undefined' && window.supabase) {
        console.log('‚úÖ Cliente Supabase encontrado');
        
        // Obtener usuario actual
        window.supabase.auth.getUser().then(({ data: { user }, error }) => {
            if (error) {
                console.error('‚ùå Error al obtener usuario:', error);
                return;
            }
            
            if (user) {
                console.log('‚úÖ Usuario autenticado:', {
                    id: user.id,
                    email: user.email,
                    role: user.role
                });
            } else {
                console.error('‚ùå Usuario no autenticado');
            }
        });
    } else {
        console.error('‚ùå Cliente Supabase no encontrado');
    }
}

// 2. Verificar pol√≠ticas RLS
function verificarPoliticasRLS() {
    console.log('\nüìã 2. VERIFICANDO POL√çTICAS RLS');
    
    if (window.supabase) {
        // Consultar pol√≠ticas activas
        const query = `
            SELECT 
                schemaname,
                tablename,
                policyname,
                permissive,
                roles,
                cmd,
                qual,
                with_check
            FROM pg_policies 
            WHERE schemaname = 'public' 
              AND tablename = 'plan_accion'
            ORDER BY policyname;
        `;
        
        window.supabase.rpc('execute_sql', { query })
            .then(({ data, error }) => {
                if (error) {
                    console.error('‚ùå Error al consultar pol√≠ticas RLS:', error);
                } else {
                    console.log('‚úÖ Pol√≠ticas RLS activas:', data);
                }
            })
            .catch(err => {
                console.log('‚ÑπÔ∏è No se pudo ejecutar consulta SQL directa (normal en producci√≥n)');
            });
    }
}

// 3. Interceptar llamadas a Supabase
function interceptarLlamadasSupabase() {
    console.log('\nüìã 3. INTERCEPTANDO LLAMADAS A SUPABASE');
    
    // Interceptar fetch para capturar llamadas a Supabase
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        const [url, options] = args;
        
        // Solo interceptar llamadas a Supabase
        if (url && url.includes('supabase') && url.includes('plan_accion')) {
            console.log('üîó Llamada a Supabase interceptada:', {
                url,
                method: options?.method || 'GET',
                headers: options?.headers,
                body: options?.body
            });
            
            // Parsear el body si es JSON
            if (options?.body) {
                try {
                    const bodyData = JSON.parse(options.body);
                    console.log('üì¶ Datos enviados:', bodyData);
                    
                    // Verificar campos demogr√°ficos espec√≠ficamente
                    const camposDemograficos = {
                        grupo_etareo: bodyData.grupo_etareo,
                        grupo_poblacion: bodyData.grupo_poblacion,
                        zona: bodyData.zona,
                        grupo_etnico: bodyData.grupo_etnico,
                        cantidad: bodyData.cantidad
                    };
                    
                    console.log('üë• Campos demogr√°ficos en la petici√≥n:', camposDemograficos);
                    
                    // Verificar si hay campos demogr√°ficos con valores
                    const tieneValoresDemograficos = Object.values(camposDemograficos).some(valor => 
                        valor !== null && valor !== undefined && valor !== ''
                    );
                    
                    if (tieneValoresDemograficos) {
                        console.log('‚úÖ Se encontraron datos demogr√°ficos en la petici√≥n');
                    } else {
                        console.warn('‚ö†Ô∏è No se encontraron datos demogr√°ficos en la petici√≥n');
                    }
                } catch (e) {
                    console.log('‚ÑπÔ∏è Body no es JSON v√°lido');
                }
            }
        }
        
        // Ejecutar la petici√≥n original y capturar la respuesta
        return originalFetch.apply(this, args)
            .then(response => {
                if (url && url.includes('supabase') && url.includes('plan_accion')) {
                    console.log('üì• Respuesta de Supabase:', {
                        status: response.status,
                        statusText: response.statusText,
                        ok: response.ok
                    });
                    
                    // Clonar la respuesta para poder leerla
                    const responseClone = response.clone();
                    responseClone.text().then(text => {
                        try {
                            const responseData = JSON.parse(text);
                            console.log('üìÑ Datos de respuesta:', responseData);
                            
                            if (responseData.error) {
                                console.error('‚ùå Error en respuesta de Supabase:', responseData.error);
                            }
                        } catch (e) {
                            console.log('üìÑ Respuesta (texto):', text);
                        }
                    });
                }
                
                return response;
            })
            .catch(error => {
                if (url && url.includes('supabase')) {
                    console.error('‚ùå Error en petici√≥n a Supabase:', error);
                }
                throw error;
            });
    };
    
    console.log('‚úÖ Interceptor de fetch activado');
}

// 4. Probar inserci√≥n directa
function probarInsercionDirecta() {
    console.log('\nüìã 4. PROBANDO INSERCI√ìN DIRECTA');
    
    if (!window.supabase) {
        console.error('‚ùå Cliente Supabase no disponible');
        return;
    }
    
    const datosTest = {
        titulo: 'Test Demogr√°fico - ' + new Date().toISOString(),
        descripcion: 'Prueba de inserci√≥n de datos demogr√°ficos',
        area_id: '3faec50d-30df-494e-8474-b2c4a091b3a2', // ID del √°rea visible en la imagen
        grupo_etareo: 'Adultos (18-64 a√±os)',
        grupo_poblacion: 'Poblaci√≥n general',
        zona: 'Urbana',
        grupo_etnico: 'Mestizo',
        cantidad: 100,
        fecha_inicio: new Date().toISOString().split('T')[0],
        fecha_fin: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
    };
    
    console.log('üì¶ Datos de prueba:', datosTest);
    
    window.supabase
        .from('plan_accion')
        .insert(datosTest)
        .then(({ data, error }) => {
            if (error) {
                console.error('‚ùå Error en inserci√≥n directa:', error);
                console.error('üìã Detalles del error:', {
                    message: error.message,
                    details: error.details,
                    hint: error.hint,
                    code: error.code
                });
            } else {
                console.log('‚úÖ Inserci√≥n directa exitosa:', data);
            }
        });
}

// 5. Verificar datos existentes
function verificarDatosExistentes() {
    console.log('\nüìã 5. VERIFICANDO DATOS EXISTENTES');
    
    if (!window.supabase) {
        console.error('‚ùå Cliente Supabase no disponible');
        return;
    }
    
    window.supabase
        .from('plan_accion')
        .select('id, titulo, grupo_etareo, grupo_poblacion, zona, grupo_etnico, cantidad')
        .limit(5)
        .then(({ data, error }) => {
            if (error) {
                console.error('‚ùå Error al consultar datos:', error);
            } else {
                console.log('üìä √öltimos registros:', data);
                
                // Verificar si hay registros con datos demogr√°ficos
                const conDatosDemograficos = data.filter(registro => 
                    registro.grupo_etareo || registro.grupo_poblacion || 
                    registro.zona || registro.grupo_etnico || registro.cantidad
                );
                
                console.log(`üìà Registros con datos demogr√°ficos: ${conDatosDemograficos.length}/${data.length}`);
                
                if (conDatosDemograficos.length > 0) {
                    console.log('‚úÖ Ejemplos con datos demogr√°ficos:', conDatosDemograficos);
                } else {
                    console.warn('‚ö†Ô∏è No se encontraron registros con datos demogr√°ficos');
                }
            }
        });
}

// 6. Funci√≥n principal de diagn√≥stico
function ejecutarDiagnostico() {
    console.log('üöÄ EJECUTANDO DIAGN√ìSTICO COMPLETO\n');
    
    verificarAutenticacion();
    setTimeout(() => verificarPoliticasRLS(), 1000);
    setTimeout(() => interceptarLlamadasSupabase(), 2000);
    setTimeout(() => verificarDatosExistentes(), 3000);
    
    console.log('\n‚è∞ Diagn√≥stico programado. Ahora intenta enviar un formulario con datos demogr√°ficos.');
    console.log('üìù Para probar inserci√≥n directa, ejecuta: probarInsercionDirecta()');
}

// Exportar funciones para uso manual
window.diagnosticoDemografico = {
    ejecutar: ejecutarDiagnostico,
    verificarAuth: verificarAutenticacion,
    verificarRLS: verificarPoliticasRLS,
    interceptar: interceptarLlamadasSupabase,
    probarInsercion: probarInsercionDirecta,
    verificarDatos: verificarDatosExistentes
};

// Ejecutar autom√°ticamente
ejecutarDiagnostico();

console.log('\nüéØ DIAGN√ìSTICO INICIADO');
console.log('üí° Usa window.diagnosticoDemografico para acceder a las funciones individuales');
console.log('üìã Ejemplo: window.diagnosticoDemografico.probarInsercion()');